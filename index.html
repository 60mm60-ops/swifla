<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Çπ„Ç§„Éï„É©ÔºàSwitch FlashÔºâ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e1e5e9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #f8f9fa;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            color: #adb5bd;
            font-size: 1.1rem;
        }

        /* Ëâ≤ÂÖ•Âäõ„Ç®„É™„Ç¢ */
        .color-input-section {
            background: rgba(30, 39, 54, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .color-input-row {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .color-preview {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .color-preview:hover {
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .hex-input {
            padding: 12px 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 16px;
            text-transform: uppercase;
            width: 120px;
            background: rgba(40, 50, 68, 0.8);
            color: #f8f9fa;
        }

        .hex-input:focus {
            outline: none;
            border-color: #64b5f6;
            background: rgba(40, 50, 68, 1);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: rgba(108, 117, 125, 0.8);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-secondary:hover {
            background: rgba(134, 142, 150, 0.9);
            transform: translateY(-2px);
        }

        /* „Éë„Çø„Éº„É≥ÂàáÊõø */
        .pattern-toggles {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 25px;
        }

        .pattern-toggle {
            position: relative;
        }

        .pattern-toggle input {
            position: absolute;
            opacity: 0;
        }

        .pattern-toggle label {
            display: block;
            padding: 10px 16px;
            background: rgba(40, 50, 68, 0.8);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
            color: #e1e5e9;
        }

        .pattern-toggle input:checked + label {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* „Ç´„Éº„Éâ„É™„Çπ„Éà */
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .card {
            background: rgba(30, 39, 54, 0.95);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            transition: all 0.3s;
            opacity: 1;
            transform: scale(1) rotateY(0deg);
            display: flex;
            flex-direction: column;
        }

        .card:hover {
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.5);
        }

        .card.flip-out {
            opacity: 0;
            transform: scale(0.8) rotateY(90deg);
        }

        .card.flip-in {
            animation: flipIn 0.3s ease-out;
        }

        @keyframes flipIn {
            from {
                opacity: 0;
                transform: scale(0.8) rotateY(-90deg);
            }
            to {
                opacity: 1;
                transform: scale(1) rotateY(0deg);
            }
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #f8f9fa;
        }

        .card-close {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
            opacity: 0.7;
        }

        .card-close:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        .color-swatches {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .color-swatch {
            flex: 1;
            height: 50px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .color-swatch:hover {
            transform: translateY(-3px);
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }

        .color-swatch:focus {
            outline: 2px solid #64b5f6;
            outline-offset: 2px;
        }

        .hex-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
        }

        .hex-item {
            background: rgba(40, 50, 68, 0.8);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            color: #e1e5e9;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .hex-item:hover {
            background: rgba(60, 70, 88, 0.9);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .card-meta {
            margin-top: 10px;
            font-size: 11px;
            color: #adb5bd;
        }

        /* Êìç‰Ωú„Éê„Éº */
        .action-bar {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 25px;
        }

        /* „ÅäÊ∞ó„Å´ÂÖ•„Çä„Çª„ÇØ„Ç∑„Éß„É≥ */
        .favorites-section {
            background: rgba(30, 39, 54, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            margin-bottom: 25px;
        }

        .favorites-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .favorites-title {
            font-size: 18px;
            font-weight: 600;
            color: #f8f9fa;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .favorites-count {
            background: rgba(102, 126, 234, 0.3);
            color: #64b5f6;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .favorites-actions {
            display: flex;
            gap: 10px;
        }

        .favorites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
            min-height: 60px;
        }

        .favorite-slot {
            aspect-ratio: 1;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .favorite-slot.empty {
            border-style: dashed;
            background: rgba(40, 50, 68, 0.5);
            color: #adb5bd;
            font-size: 24px;
        }

        .favorite-slot.empty:hover {
            border-color: rgba(102, 126, 234, 0.5);
            background: rgba(102, 126, 234, 0.1);
        }

        .favorite-slot:not(.empty):hover {
            transform: translateY(-3px);
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }

        .favorite-remove {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 12px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .favorite-slot:hover .favorite-remove {
            display: flex;
        }

        .favorite-hex {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #adb5bd;
            font-family: 'Monaco', 'Menlo', monospace;
            white-space: nowrap;
        }

        .favorites-empty {
            text-align: center;
            color: #adb5bd;
            font-style: italic;
            padding: 30px;
        }

        /* „ÅäÊ∞ó„Å´ÂÖ•„Çä„Éú„Çø„É≥ */
        .favorite-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-radius: 50%;
            color: #ffd700;
            font-size: 12px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .color-swatch:hover .favorite-btn {
            display: flex;
        }

        .favorite-btn:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }

        .history-section {
            background: rgba(30, 39, 54, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .history-title {
            font-size: 18px;
            font-weight: 600;
            color: #f8f9fa;
            margin-bottom: 15px;
        }

        .history-list {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .history-item {
            flex-shrink: 0;
            width: 120px;
            background: rgba(40, 50, 68, 0.8);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .history-item:hover {
            border-color: #64b5f6;
            transform: translateY(-2px);
        }

        .history-preview {
            display: flex;
            gap: 2px;
            margin-bottom: 8px;
        }

        .history-color {
            flex: 1;
            height: 20px;
            border-radius: 2px;
        }

        .history-info {
            font-size: 11px;
            color: #adb5bd;
            text-align: center;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        /* „Éà„Éº„Çπ„Éà */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* „Ç´„É©„Éº„Éî„ÉÉ„Ç´„Éº„É¢„Éº„ÉÄ„É´ */
        .color-picker-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .color-picker-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .color-picker-content {
            background: rgba(25, 32, 45, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .picker-title {
            color: #f8f9fa;
            font-size: 20px;
            font-weight: 600;
        }

        .picker-close {
            background: none;
            border: none;
            color: #adb5bd;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .picker-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #f8f9fa;
        }

        .picker-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            background: rgba(40, 50, 68, 0.8);
            border-radius: 10px;
            padding: 5px;
        }

        .picker-tab {
            flex: 1;
            padding: 10px 15px;
            background: none;
            border: none;
            color: #adb5bd;
            font-size: 14px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .picker-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .picker-view {
            display: none;
        }

        .picker-view.active {
            display: block;
        }

        /* „Çπ„Éö„ÇØ„Éà„É©„É†„Éì„É•„Éº */
        .spectrum-picker {
            width: 100%;
            height: 200px;
            border-radius: 10px;
            position: relative;
            cursor: crosshair;
            margin-bottom: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .spectrum-cursor {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .hue-slider {
            width: 100%;
            height: 20px;
            border-radius: 10px;
            background: linear-gradient(to right, 
                #ff0000 0%, #ffff00 17%, #00ff00 33%, #00ffff 50%, 
                #0000ff 67%, #ff00ff 83%, #ff0000 100%);
            position: relative;
            cursor: pointer;
            margin-bottom: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .hue-cursor {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            top: 50%;
            pointer-events: none;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        /* „Ç∞„É™„ÉÉ„Éâ„Éì„É•„Éº */
        .grid-picker {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .grid-color {
            aspect-ratio: 1;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s;
        }

        .grid-color:hover {
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* „Çπ„É©„Ç§„ÉÄ„Éº„Éì„É•„Éº */
        .slider-view {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .slider-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .slider-label {
            color: #f8f9fa;
            font-size: 14px;
            font-weight: 500;
            min-width: 50px;
        }

        .color-slider {
            flex: 1;
            height: 20px;
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .slider-cursor {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            top: 50%;
            pointer-events: none;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .slider-value {
            color: #adb5bd;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            min-width: 40px;
            text-align: right;
        }

        /* „Éó„É¨„Éì„É•„Éº„Ç®„É™„Ç¢ */
        .picker-preview {
            display: flex;
            gap: 15px;
            align-items: center;
            padding: 15px;
            background: rgba(40, 50, 68, 0.8);
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .preview-color {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .preview-info {
            flex: 1;
        }

        .preview-hex {
            color: #f8f9fa;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .preview-values {
            color: #adb5bd;
            font-size: 12px;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        /* „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ */
        .picker-actions {
            display: flex;
            gap: 10px;
        }

        .picker-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .picker-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .picker-btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
        }

        .picker-btn-secondary {
            background: rgba(108, 117, 125, 0.8);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .picker-btn-secondary:hover {
            background: rgba(134, 142, 150, 0.9);
        }

        @media (max-width: 768px) {
            .color-input-row {
                flex-direction: column;
            }
            
            .pattern-toggles {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .cards-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üé® „Çπ„Ç§„Éï„É©</h1>
            <p>Switch Flash - „Ç´„É©„Éº„Éë„É¨„ÉÉ„ÉàÁîüÊàê„ÉÑ„Éº„É´</p>
        </header>

        <section class="color-input-section">
            <div class="color-input-row">
                <div class="color-preview" id="colorPreview"></div>
                <input type="text" class="hex-input" id="hexInput" placeholder="#3366FF" pattern="^#?[0-9A-Fa-f]{6}$">
                <button class="btn btn-primary" id="randomBtn">üé≤ „É©„É≥„ÉÄ„É†</button>
                <button class="btn btn-secondary" id="copyBaseBtn">üìã „Ç≥„Éî„Éº</button>
            </div>
        </section>

        <section class="pattern-toggles" id="patternToggles">
            <div class="pattern-toggle">
                <input type="checkbox" id="monochrome" checked>
                <label for="monochrome">„É¢„Éé„ÇØ„É≠„Éº„É†</label>
            </div>
            <div class="pattern-toggle">
                <input type="checkbox" id="analogous" checked>
                <label for="analogous">È°û‰ººËâ≤</label>
            </div>
            <div class="pattern-toggle">
                <input type="checkbox" id="complementary" checked>
                <label for="complementary">Ë£úËâ≤</label>
            </div>
            <div class="pattern-toggle">
                <input type="checkbox" id="splitComp" checked>
                <label for="splitComp">ÂàÜÂâ≤Ë£úËâ≤</label>
            </div>
            <div class="pattern-toggle">
                <input type="checkbox" id="triad" checked>
                <label for="triad">‰∏âËâ≤ÈÖçËâ≤</label>
            </div>
            <div class="pattern-toggle">
                <input type="checkbox" id="tetrad" checked>
                <label for="tetrad">ÂõõËâ≤ÈÖçËâ≤</label>
            </div>
        </section>

        <section class="cards-container" id="cardsContainer">
        </section>

        <div class="color-picker-modal" id="colorPickerModal">
            <div class="color-picker-content">
                <div class="picker-header">
                    <h3 class="picker-title">„Ç´„É©„ÉºÈÅ∏Êäû</h3>
                    <button class="picker-close" id="pickerClose">&times;</button>
                </div>
                
                <div class="picker-tabs">
                    <button class="picker-tab active" data-view="spectrum">„Çπ„Éö„ÇØ„Éà„É©„É†</button>
                    <button class="picker-tab" data-view="slider">„Çπ„É©„Ç§„ÉÄ„Éº</button>
                    <button class="picker-tab" data-view="grid">„Ç∞„É™„ÉÉ„Éâ</button>
                </div>

                <div class="picker-view active" id="spectrumView">
                    <div class="spectrum-picker" id="spectrumPicker">
                        <div class="spectrum-cursor" id="spectrumCursor"></div>
                    </div>
                    <div class="hue-slider" id="hueSlider">
                        <div class="hue-cursor" id="hueCursor"></div>
                    </div>
                </div>

                <div class="picker-view" id="sliderView">
                    <div class="slider-view">
                        <div class="slider-group">
                            <span class="slider-label">Ëµ§</span>
                            <div class="color-slider" id="redSlider">
                                <div class="slider-cursor" id="redCursor"></div>
                            </div>
                            <span class="slider-value" id="redValue">255</span>
                        </div>
                        <div class="slider-group">
                            <span class="slider-label">Á∑ë</span>
                            <div class="color-slider" id="greenSlider">
                                <div class="slider-cursor" id="greenCursor"></div>
                            </div>
                            <span class="slider-value" id="greenValue">255</span>
                        </div>
                        <div class="slider-group">
                            <span class="slider-label">Èùí</span>
                            <div class="color-slider" id="blueSlider">
                                <div class="slider-cursor" id="blueCursor"></div>
                            </div>
                            <span class="slider-value" id="blueValue">255</span>
                        </div>
                    </div>
                </div>

                <div class="picker-view" id="gridView">
                    <div class="grid-picker" id="gridPicker">
                        </div>
                </div>

                <div class="picker-preview">
                    <div class="preview-color" id="previewColor"></div>
                    <div class="preview-info">
                        <div class="preview-hex" id="previewHex">#FF0000</div>
                        <div class="preview-values" id="previewValues">RGB(255, 0, 0)</div>
                    </div>
                </div>

                <div class="picker-actions">
                    <button class="picker-btn picker-btn-secondary" id="pickerCancel">„Ç≠„É£„É≥„Çª„É´</button>
                    <button class="picker-btn picker-btn-primary" id="pickerOk">ÈÅ©Áî®</button>
                </div>
            </div>
        </div>

        <section class="action-bar">
            <button class="btn btn-primary" id="refreshBtn">üîÑ ÂÖ®ÂÜçË®àÁÆó</button>
            <button class="btn btn-primary" id="saveBtn">üíæ ‰øùÂ≠ò</button>
            <button class="btn btn-primary" id="exportBtn">üì§ PNGÂá∫Âäõ</button>
        </section>

        <section class="favorites-section">
            <div class="favorites-header">
                <h3 class="favorites-title">
                    ‚≠ê „ÅäÊ∞ó„Å´ÂÖ•„ÇäËâ≤
                    <span class="favorites-count" id="favoritesCount">0/10</span>
                </h3>
                <div class="favorites-actions">
                    <button class="btn btn-secondary" id="clearFavoritesBtn">üóëÔ∏è „ÇØ„É™„Ç¢</button>
                    <button class="btn btn-primary" id="exportFavoritesBtn">üì§ PNGÂá∫Âäõ</button>
                </div>
            </div>
            <div class="favorites-grid" id="favoritesGrid">
                </div>
        </section>

        <section class="history-section">
            <h3 class="history-title">Â±•Ê≠¥</h3>
            <div class="history-list" id="historyList">
            </div>
        </section>
    </div>

    <script>
        // Áä∂ÊÖãÁÆ°ÁêÜ
        let state = {
            baseColor: '#3366FF',
            patternsEnabled: {
                monochrome: true,
                analogous: true,
                complementary: true,
                splitComp: true,
                triad: true,
                tetrad: true
            },
            cards: [],
            history: [],
            favorites: [], // „ÅäÊ∞ó„Å´ÂÖ•„ÇäËâ≤„É™„Çπ„ÉàÔºàÊúÄÂ§ß10Ëâ≤Ôºâ
            ui: {
                flipping: false,
                toast: null
            }
        };

        // Ëâ≤Â§âÊèõ„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        function rgbToHex(r, g, b) {
            return "#" + [r, g, b].map(x => {
                const hex = Math.round(x).toString(16);
                return hex.length === 1 ? "0" + hex : hex;
            }).join("");
        }

        function rgbToHsl(r, g, b) {
            r /= 255;
            g /= 255;
            b /= 255;
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;

            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return { h: h * 360, s, l };
        }

        function hslToRgb(h, s, l) {
            h /= 360;
            const hue2rgb = (p, q, t) => {
                if (t < 0) t += 1;
                if (t > 1) t -= 1;
                if (t < 1/6) return p + (q - p) * 6 * t;
                if (t < 1/2) return q;
                if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                return p;
            };

            if (s === 0) {
                return { r: l * 255, g: l * 255, b: l * 255 };
            }

            const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
            const p = 2 * l - q;
            const r = hue2rgb(p, q, h + 1/3);
            const g = hue2rgb(p, q, h);
            const b = hue2rgb(p, q, h - 1/3);

            return { r: r * 255, g: g * 255, b: b * 255 };
        }

        function shiftHue(h, deg) {
            return (h + deg + 360) % 360;
        }

        function clamp01(x) {
            return Math.max(0, Math.min(1, x));
        }

        function adj(v, amt) {
            return clamp01(v + amt);
        }

        // „Ç´„É©„Éº„Éë„Çø„Éº„É≥ÁîüÊàê
        function generateMonochrome(h, s, l) {
            const colors = [rgbToHex(...Object.values(hslToRgb(h, s, l)))];
            
            // „É¢„Éé„ÇØ„É≠„Éº„É†„ÅØ5Ëâ≤„ÅÆ„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ÁöÑ„Éê„É™„Ç®„Éº„Ç∑„Éß„É≥
            const variations = [
                { s: adj(s, -0.1), l: adj(l, 0.1) },
                { s: adj(s, 0.05), l: adj(l, -0.15) },
                { s: adj(s, -0.05), l: adj(l, 0.2) },
                { s: adj(s, 0.1), l: adj(l, -0.1) }
            ];

            variations.forEach(v => {
                colors.push(rgbToHex(...Object.values(hslToRgb(h, v.s, v.l))));
            });

            return colors;
        }

        function generateAnalogous(h, s, l) {
            // È°û‰ººËâ≤„ÅØ5Ëâ≤ÔºàÂü∫Ê∫ñËâ≤ + ¬±15¬∞, ¬±30¬∞Ôºâ
            const hues = [h - 30, h - 15, h, h + 15, h + 30];
            return hues.map(hue => 
                rgbToHex(...Object.values(hslToRgb(shiftHue(hue, 0), s, l)))
            );
        }

        function generateComplementary(h, s, l) {
            // Ë£úËâ≤„ÅØÊú¨Êù•„ÅÆ2Ëâ≤„ÅÆ„Åø
            const hues = [h, h + 180];
            return hues.map(hue => 
                rgbToHex(...Object.values(hslToRgb(hue, s, l)))
            );
        }

        function generateSplitComp(h, s, l) {
            // ÂàÜÂâ≤Ë£úËâ≤„ÅØÊú¨Êù•„ÅÆ3Ëâ≤„ÅÆ„Åø
            const hues = [h, h + 150, h + 210];
            return hues.map(hue => 
                rgbToHex(...Object.values(hslToRgb(shiftHue(hue, 0), s, l)))
            );
        }

        function generateTriad(h, s, l) {
            // ‰∏âËâ≤ÈÖçËâ≤„ÅØÊú¨Êù•„ÅÆ3Ëâ≤„ÅÆ„Åø
            const hues = [h, h + 120, h + 240];
            return hues.map(hue => 
                rgbToHex(...Object.values(hslToRgb(shiftHue(hue, 0), s, l)))
            );
        }

        function generateTetrad(h, s, l) {
            // ÂõõËâ≤ÈÖçËâ≤„ÅØÊú¨Êù•„ÅÆ4Ëâ≤„ÅÆ„Åø
            const hues = [h, h + 90, h + 180, h + 270];
            return hues.map(hue => 
                rgbToHex(...Object.values(hslToRgb(shiftHue(hue, 0), s, l)))
            );
        }

        // „Ç´„É©„Éº„Éî„ÉÉ„Ç´„ÉºÈñ¢ÈÄ£
        let colorPicker = {
            currentColor: '#FF0000',
            currentView: 'spectrum',
            isOpen: false,
            hsl: { h: 0, s: 1, l: 0.5 },
            rgb: { r: 255, g: 0, b: 0 },
            callback: null
        };

        function openColorPicker(initialColor, callback) {
            colorPicker.currentColor = initialColor;
            colorPicker.callback = callback;
            colorPicker.isOpen = true;
            
            // ÂàùÊúüËâ≤„ÇíHSL/RGB„Å´Â§âÊèõ
            const rgb = hexToRgb(initialColor);
            colorPicker.rgb = rgb;
            colorPicker.hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
            
            updatePickerUI();
            document.getElementById('colorPickerModal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeColorPicker() {
            colorPicker.isOpen = false;
            document.getElementById('colorPickerModal').classList.remove('show');
            document.body.style.overflow = '';
        }

        function updatePickerUI() {
            updatePreview();
            updateSpectrumView();
            updateSliderView();
        }

        function updatePreview() {
            const hex = rgbToHex(colorPicker.rgb.r, colorPicker.rgb.g, colorPicker.rgb.b);
            colorPicker.currentColor = hex;
            
            document.getElementById('previewColor').style.backgroundColor = hex;
            document.getElementById('previewHex').textContent = hex;
            document.getElementById('previewValues').textContent = 
                `RGB(${Math.round(colorPicker.rgb.r)}, ${Math.round(colorPicker.rgb.g)}, ${Math.round(colorPicker.rgb.b)})`;
        }

        function updateSpectrumView() {
            // „Çπ„Éö„ÇØ„Éà„É©„É†„Éî„ÉÉ„Ç´„Éº„ÅÆËÉåÊôØ„ÇíÊõ¥Êñ∞
            const spectrum = document.getElementById('spectrumPicker');
            const hue = colorPicker.hsl.h;
            const hueColor = hslToRgb(hue, 1, 0.5);
            const hueHex = rgbToHex(hueColor.r, hueColor.g, hueColor.b);
            
            spectrum.style.background = `
                linear-gradient(to top, #000 0%, transparent 100%),
                linear-gradient(to right, #fff 0%, transparent 100%),
                ${hueHex}
            `;
            
            // „Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ„ÇíÊõ¥Êñ∞
            const spectrumCursor = document.getElementById('spectrumCursor');
            const x = colorPicker.hsl.s * 100;
            const y = (1 - colorPicker.hsl.l) * 100;
            spectrumCursor.style.left = `${Math.max(0, Math.min(100, x))}%`;
            spectrumCursor.style.top = `${Math.max(0, Math.min(100, y))}%`;
            
            // Ëâ≤Áõ∏„Çπ„É©„Ç§„ÉÄ„Éº„ÅÆ„Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ
            const hueCursor = document.getElementById('hueCursor');
            hueCursor.style.left = `${(colorPicker.hsl.h / 360) * 100}%`;
        }

        function updateSliderView() {
            // RGB„Çπ„É©„Ç§„ÉÄ„Éº„ÅÆËÉåÊôØ„Å®‰ΩçÁΩÆ„ÇíÊõ¥Êñ∞
            const r = Math.round(colorPicker.rgb.r);
            const g = Math.round(colorPicker.rgb.g);
            const b = Math.round(colorPicker.rgb.b);
            
            const redSlider = document.getElementById('redSlider');
            const greenSlider = document.getElementById('greenSlider');
            const blueSlider = document.getElementById('blueSlider');
            
            redSlider.style.background = `linear-gradient(to right, 
                rgb(0, ${g}, ${b}), 
                rgb(255, ${g}, ${b}))`;
            greenSlider.style.background = `linear-gradient(to right, 
                rgb(${r}, 0, ${b}), 
                rgb(${r}, 255, ${b}))`;
            blueSlider.style.background = `linear-gradient(to right, 
                rgb(${r}, ${g}, 0), 
                rgb(${r}, ${g}, 255))`;
            
            // „Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ
            document.getElementById('redCursor').style.left = `${(r / 255) * 100}%`;
            document.getElementById('greenCursor').style.left = `${(g / 255) * 100}%`;
            document.getElementById('blueCursor').style.left = `${(b / 255) * 100}%`;
            
            // ÂÄ§Ë°®Á§∫
            document.getElementById('redValue').textContent = r;
            document.getElementById('greenValue').textContent = g;
            document.getElementById('blueValue').textContent = b;
        }

        function generateColorGrid() {
            const grid = document.getElementById('gridPicker');
            grid.innerHTML = '';
            
            // Âü∫Êú¨„Ç´„É©„Éº„Éë„É¨„ÉÉ„Éà
            const colors = [
                // „Ç∞„É¨„ÉºÁ≥ª
                '#000000', '#333333', '#666666', '#999999', '#cccccc', '#ffffff',
                // Ëµ§Á≥ª
                '#ff0000', '#ff6666', '#ff9999', '#ffcccc', '#660000', '#990000',
                // „Ç™„É¨„É≥„Ç∏Á≥ª
                '#ff6600', '#ff9933', '#ffcc66', '#ffe699', '#cc3300', '#cc6600',
                // ÈªÑËâ≤Á≥ª
                '#ffff00', '#ffff66', '#ffff99', '#ffffcc', '#cccc00', '#999900',
                // Á∑ëÁ≥ª
                '#00ff00', '#66ff66', '#99ff99', '#ccffcc', '#006600', '#009900',
                // ÈùíÁ∑ëÁ≥ª
                '#00ffff', '#66ffff', '#99ffff', '#ccffff', '#006666', '#009999',
                // ÈùíÁ≥ª
                '#0000ff', '#6666ff', '#9999ff', '#ccccff', '#000066', '#000099',
                // Á¥´Á≥ª
                '#ff00ff', '#ff66ff', '#ff99ff', '#ffccff', '#660066', '#990099',
                // Ëå∂Á≥ª
                '#996633', '#cc9966', '#ffcc99', '#ffe6cc', '#663300', '#cc6600',
                // „Éî„É≥„ÇØÁ≥ª
                '#ff69b4', '#ffb6c1', '#ffc0cb', '#ffe4e1', '#c71585', '#ff1493',
                // ËøΩÂä†„ÅÆÈÆÆ„ÇÑ„Åã„Å™Ëâ≤
                '#ff4500', '#32cd32', '#1e90ff', '#ffd700', '#8a2be2', '#dc143c'
            ];
            
            colors.forEach(color => {
                const colorEl = document.createElement('div');
                colorEl.className = 'grid-color';
                colorEl.style.backgroundColor = color;
                colorEl.addEventListener('click', () => {
                    const rgb = hexToRgb(color);
                    colorPicker.rgb = rgb;
                    colorPicker.hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
                    updatePickerUI();
                });
                grid.appendChild(colorEl);
            });
        }

        // „Ç´„Éº„Éâ„ÅÆÂÜçÊßãÁØâ
        function rebuildCards() {
            const rgb = hexToRgb(state.baseColor);
            if (!rgb) return;
            
            const { h, s, l } = rgbToHsl(rgb.r, rgb.g, rgb.b);
            const newCards = [];

            const generators = {
                monochrome: { fn: generateMonochrome, rule: 'HSL-based monochrome variations (5 colors)' },
                analogous: { fn: generateAnalogous, rule: 'HSL-based analogous ¬±15¬∞/¬±30¬∞ (5 colors)' },
                complementary: { fn: generateComplementary, rule: 'HSL-based complementary 180¬∞ (2 colors)' },
                splitComp: { fn: generateSplitComp, rule: 'HSL-based split-complementary 150¬∞/210¬∞ (3 colors)' },
                triad: { fn: generateTriad, rule: 'HSL-based triadic 120¬∞ (3 colors)' },
                tetrad: { fn: generateTetrad, rule: 'HSL-based tetradic 90¬∞ (4 colors)' }
            };

            Object.keys(state.patternsEnabled).forEach(pattern => {
                if (state.patternsEnabled[pattern] && generators[pattern]) {
                    const colors = generators[pattern].fn(h, s, l);
                    newCards.push({
                        id: `${pattern}-${Date.now()}`,
                        pattern,
                        colors: colors,
                        meta: {
                            rule: generators[pattern].rule,
                            generatedAt: Date.now()
                        }
                    });
                }
            });

            state.cards = newCards;
        }

        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        function playFlip() {
            if (state.ui.flipping) return;
            
            state.ui.flipping = true;
            const cards = document.querySelectorAll('.card');
            
            // „Éï„É™„ÉÉ„Éó„Ç¢„Ç¶„Éà
            cards.forEach(card => card.classList.add('flip-out'));
            
            setTimeout(() => {
                renderCards();
                setTimeout(() => {
                    const newCards = document.querySelectorAll('.card');
                    newCards.forEach(card => {
                        card.classList.remove('flip-out');
                        card.classList.add('flip-in');
                    });
                    state.ui.flipping = false;
                }, 50);
            }, 150);
        }

        // „É¨„É≥„ÉÄ„É™„É≥„Ç∞
        function renderCards() {
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';

            state.cards.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'card';
                cardEl.innerHTML = `
                    <div class="card-header">
                        <h3 class="card-title">${getPatternName(card.pattern)}</h3>
                        <button class="card-close" data-pattern="${card.pattern}" title="„Åì„ÅÆ„Ç´„Éº„Éâ„ÇíÈùûË°®Á§∫">‚ùå</button>
                    </div>
                    <div class="color-swatches">
                        ${card.colors.map((color, i) => `
                            <button class="color-swatch" 
                                style="background-color: ${color}" 
                                data-color="${color}"
                                aria-label="„ÇØ„É™„ÉÉ„ÇØÔºö„Ç≥„Éî„Éº+„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†"
                                tabindex="0">
                            </button>
                        `).join('')}
                    </div>
                    <div class="hex-list">
                        ${card.colors.map(color => `
                            <span class="hex-item" data-color="${color}">${color}</span>
                        `).join('')}
                    </div>
                    <div class="card-meta">${card.meta.rule}</div>
                `;
                container.appendChild(cardEl);
            });
        }

        function getPatternName(pattern) {
            const names = {
                monochrome: '„É¢„Éé„ÇØ„É≠„Éº„É†',
                analogous: 'È°û‰ººËâ≤',
                complementary: 'Ë£úËâ≤',
                splitComp: 'ÂàÜÂâ≤Ë£úËâ≤',
                triad: '‰∏âËâ≤ÈÖçËâ≤',
                tetrad: 'ÂõõËâ≤ÈÖçËâ≤'
            };
            return names[pattern] || pattern;
        }

        function renderHistory() {
            const container = document.getElementById('historyList');
            container.innerHTML = '';

            state.history.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'history-item';
                itemEl.innerHTML = `
                    <div class="history-preview">
                        ${item.cards[0]?.colors.slice(0, 5).map(color => `
                            <div class="history-color" style="background-color: ${color}"></div>
                        `).join('') || ''}
                    </div>
                    <div class="history-info">
                        ${item.baseColor}<br>
                        ${new Date(item.savedAt).toLocaleDateString()}
                    </div>
                `;
                itemEl.addEventListener('click', () => restoreFromHistory(item.id));
                container.appendChild(itemEl);
            });
        }

        function renderFavorites() {
            const grid = document.getElementById('favoritesGrid');
            grid.innerHTML = '';
            
            const maxFavorites = 10;
            
            state.favorites.forEach(color => {
                const slot = document.createElement('div');
                slot.className = 'favorite-slot';
                slot.style.backgroundColor = color;
                slot.dataset.color = color;
                slot.addEventListener('click', () => {
                    copyToClipboard(color).then(() => {
                        showToast(`${color} „Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü`);
                    });
                });
                
                // ÂâäÈô§„Éú„Çø„É≥
                const removeBtn = document.createElement('button');
                removeBtn.className = 'favorite-remove';
                removeBtn.dataset.color = color;
                removeBtn.textContent = '√ó';
                slot.appendChild(removeBtn);
                
                // HEXÂÄ§Ë°®Á§∫
                const hexSpan = document.createElement('span');
                hexSpan.className = 'favorite-hex';
                hexSpan.textContent = color;
                slot.appendChild(hexSpan);
                
                grid.appendChild(slot);
            });

            // Á©∫„ÅÆ„Çπ„É≠„ÉÉ„Éà„ÇíËøΩÂä†
            for (let i = state.favorites.length; i < maxFavorites; i++) {
                const emptySlot = document.createElement('div');
                emptySlot.className = 'favorite-slot empty';
                emptySlot.innerHTML = '+';
                grid.appendChild(emptySlot);
            }

            document.getElementById('favoritesCount').textContent = `${state.favorites.length}/${maxFavorites}`;
        }

        // „ÅäÊ∞ó„Å´ÂÖ•„ÇäÊ©üËÉΩ
        function addToFavorites(color, showMessage = false) {
            if (state.favorites.includes(color)) {
                if (showMessage) showToast('Êó¢„Å´„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†Ê∏à„Åø„Åß„Åô');
                return;
            }
            if (state.favorites.length >= 10) {
                if (showMessage) showToast('„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅØÊúÄÂ§ß10Ëâ≤„Åæ„Åß„Åß„Åô');
                return;
            }
            
            state.favorites.push(color);
            localStorage.setItem('suifla-favorites-v1', JSON.stringify(state.favorites));
            renderFavorites();
            if (showMessage) showToast(`‚≠ê ${color} „Çí„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†„Åó„Åæ„Åó„Åü`);
        }

        function removeFromFavorites(color) {
            state.favorites = state.favorites.filter(c => c !== color);
            localStorage.setItem('suifla-favorites-v1', JSON.stringify(state.favorites));
            renderFavorites();
            showToast(`${color} „Çí„ÅäÊ∞ó„Å´ÂÖ•„Çä„Åã„ÇâÂâäÈô§„Åó„Åæ„Åó„Åü`);
        }

        function clearFavorites() {
            if (confirm('„ÅäÊ∞ó„Å´ÂÖ•„Çä„É™„Çπ„Éà„Çí„Åô„Åπ„Å¶„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü')) {
                state.favorites = [];
                localStorage.removeItem('suifla-favorites-v1');
                renderFavorites();
                showToast('„ÅäÊ∞ó„Å´ÂÖ•„Çä„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
            }
        }

        function loadFavorites() {
            try {
                const saved = localStorage.getItem('suifla-favorites-v1');
                if (saved) {
                    state.favorites = JSON.parse(saved);
                }
            } catch (err) {
                console.error('Failed to load favorites:', err);
            }
            renderFavorites();
        }

        // „Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É™„É≥„Ç∞
        function showToast(message) {
            if (state.ui.toast) {
                document.body.removeChild(state.ui.toast);
            }
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            state.ui.toast = toast;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (state.ui.toast === toast) {
                    document.body.removeChild(toast);
                    state.ui.toast = null;
                }
            }, 2000);
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                return true;
            } catch (err) {
                console.error('Failed to copy:', err);
                showToast('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                return false;
            }
        }

        // Ëâ≤„ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅÆÁµ±ÂêàÂá¶ÁêÜ
        async function handleColorClick(color) {
            const copySuccess = await copyToClipboard(color);
            
            if (copySuccess) {
                addToFavorites(color, true);
            }
        }

        function onBaseColorChange(hex) {
            if (!/^#[0-9A-Fa-f]{6}$/.test(hex)) return;
            
            state.baseColor = hex.toUpperCase();
            document.getElementById('colorPreview').style.backgroundColor = hex;
            document.getElementById('hexInput').value = hex;
            
            rebuildCards();
            playFlip();
        }

        function generateRandomColor() {
            const hex = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
            onBaseColorChange(hex);
        }

        function togglePattern(pattern) {
            state.patternsEnabled[pattern] = !state.patternsEnabled[pattern];
            rebuildCards();
            playFlip();
        }

        function saveToHistory() {
            const historyItem = {
                id: Date.now().toString(),
                baseColor: state.baseColor,
                selectedPatterns: Object.keys(state.patternsEnabled).filter(p => state.patternsEnabled[p]),
                cards: JSON.parse(JSON.stringify(state.cards)),
                savedAt: Date.now()
            };
            
            state.history.unshift(historyItem);
            if (state.history.length > 24) {
                state.history = state.history.slice(0, 24);
            }
            
            localStorage.setItem('suifla-history-v1', JSON.stringify(state.history));
            renderHistory();
            showToast('Â±•Ê≠¥„Å´‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
        }

        function restoreFromHistory(id) {
            const item = state.history.find(h => h.id === id);
            if (!item) return;
            
            state.baseColor = item.baseColor;
            
            // „Éë„Çø„Éº„É≥„ÇíÂàùÊúüÂåñ„Åó„Å¶„Åã„ÇâË®≠ÂÆö
            Object.keys(state.patternsEnabled).forEach(p => {
                state.patternsEnabled[p] = false;
            });
            item.selectedPatterns.forEach(p => {
                if (state.patternsEnabled.hasOwnProperty(p)) {
                    state.patternsEnabled[p] = true;
                }
            });
            
            // UIÊõ¥Êñ∞
            document.getElementById('colorPreview').style.backgroundColor = item.baseColor;
            document.getElementById('hexInput').value = item.baseColor;
            document.querySelectorAll('.pattern-toggle input').forEach(input => {
                input.checked = state.patternsEnabled[input.id] || false;
            });
            
            rebuildCards();
            playFlip();
            showToast('Â±•Ê≠¥„Åã„ÇâÂæ©ÂÖÉ„Åó„Åæ„Åó„Åü');
        }

        function exportToPng() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const cardWidth = 300;
            const cardHeight = 200;
            const margin = 20;
            const cols = Math.min(3, state.cards.length);
            const rows = Math.ceil(state.cards.length / cols);
            
            canvas.width = cols * cardWidth + (cols + 1) * margin;
            canvas.height = rows * cardHeight + (rows + 1) * margin;
            
            // ËÉåÊôØ
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            state.cards.forEach((card, index) => {
                const col = index % cols;
                const row = Math.floor(index / cols);
                const x = margin + col * (cardWidth + margin);
                const y = margin + row * (cardHeight + margin);
                
                // „Ç´„Éº„ÉâËÉåÊôØ
                ctx.fillStyle = '#2b2b40';
                ctx.fillRect(x, y, cardWidth, cardHeight);
                
                // „Çø„Ç§„Éà„É´
                ctx.fillStyle = '#f8f9fa';
                ctx.font = 'bold 18px sans-serif';
                ctx.fillText(getPatternName(card.pattern), x + 15, y + 30);
                
                // Âü∫Ê∫ñËâ≤Ë°®Á§∫
                ctx.fillStyle = '#adb5bd';
                ctx.font = '12px monospace';
                ctx.fillText(`Base: ${state.baseColor}`, x + 15, y + 50);
                
                // „Ç´„É©„Éº„Çπ„Ç¶„Ç©„ÉÉ„ÉÅ
                const swatchWidth = (cardWidth - 30 - (card.colors.length - 1) * 8) / card.colors.length;
                const swatchHeight = 50;
                card.colors.forEach((color, i) => {
                    ctx.fillStyle = color;
                    const swatchX = x + 15 + i * (swatchWidth + 8);
                    ctx.fillRect(swatchX, y + 65, swatchWidth, swatchHeight);
                    
                    // „Çπ„Ç¶„Ç©„ÉÉ„ÉÅÊû†
                    ctx.strokeStyle = 'rgba(255,255,255,0.2)';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(swatchX, y + 65, swatchWidth, swatchHeight);
                });
                
                // HEXÂÄ§
                ctx.fillStyle = '#e1e5e9';
                ctx.font = '11px monospace';
                card.colors.forEach((color, i) => {
                    const swatchX = x + 15 + i * (swatchWidth + 8);
                    const textX = swatchX + (swatchWidth - ctx.measureText(color).width) / 2;
                    ctx.fillText(color, textX, y + 130);
                });
                
                // „É´„Éº„É´Ë™¨Êòé
                ctx.fillStyle = '#adb5bd';
                ctx.font = '10px sans-serif';
                ctx.fillText(card.meta.rule, x + 15, y + 160);
                
                // ÁîüÊàêÊó•ÊôÇ
                ctx.fillStyle = '#7f8c8d';
                ctx.font = '9px sans-serif';
                const dateText = new Date(card.meta.generatedAt).toLocaleString('ja-JP');
                ctx.fillText(dateText, x + 15, y + 175);
            });
            
            // „Éò„ÉÉ„ÉÄ„ÉºÊÉÖÂ†±
            if (state.cards.length > 0) {
                ctx.fillStyle = '#f8f9fa';
                ctx.font = 'bold 24px sans-serif';
                ctx.fillText('üé® „Çπ„Ç§„Éï„É© - „Ç´„É©„Éº„Éë„É¨„ÉÉ„Éà', 20, 30);
                
                ctx.fillStyle = '#adb5bd';
                ctx.font = '14px sans-serif';
                ctx.fillText(`Generated: ${new Date().toLocaleString('ja-JP')}`, 20, 50);
            }
            
            // „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
            const link = document.createElement('a');
            link.download = `suifla-palette-${state.baseColor.replace('#', '')}-${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();
            
            showToast('PNGÁîªÂÉè„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü');
        }

        function exportFavoritesPng() {
            if (state.favorites.length === 0) {
                showToast('„ÅäÊ∞ó„Å´ÂÖ•„Çä„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const slotSize = 100;
            const margin = 20;
            const cols = 5;
            const rows = Math.ceil(state.favorites.length / cols);
            
            canvas.width = cols * slotSize + (cols + 1) * margin;
            canvas.height = rows * slotSize + (rows + 1) * margin;
            
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#f8f9fa';
            ctx.font = 'bold 24px sans-serif';
            ctx.fillText('‚≠ê „Çπ„Ç§„Éï„É© - „ÅäÊ∞ó„Å´ÂÖ•„ÇäËâ≤', margin, margin + 20);
            
            const startY = margin * 2 + 20;

            state.favorites.forEach((color, index) => {
                const col = index % cols;
                const row = Math.floor(index / cols);
                const x = margin + col * (slotSize + margin);
                const y = startY + row * (slotSize + margin);
                
                ctx.fillStyle = color;
                ctx.fillRect(x, y, slotSize, slotSize);
                
                ctx.strokeStyle = '#e1e5e9';
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, slotSize, slotSize);
                
                ctx.fillStyle = '#fff';
                ctx.font = '12px monospace';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(color, x + slotSize / 2, y + slotSize + 15);
            });

            const link = document.createElement('a');
            link.download = `suifla-favorites-${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();
            
            showToast('„ÅäÊ∞ó„Å´ÂÖ•„ÇäÁîªÂÉè„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü');
        }

        function loadHistory() {
            try {
                const saved = localStorage.getItem('suifla-history-v1');
                if (saved) {
                    state.history = JSON.parse(saved);
                    renderHistory();
                }
            } catch (err) {
                console.error('Failed to load history:', err);
            }
        }

        // ÂàùÊúüÂåñ
        function init() {
            // ÂàùÊúüËâ≤Ë®≠ÂÆö
            const initialColor = state.baseColor;
            document.getElementById('colorPreview').style.backgroundColor = initialColor;
            document.getElementById('hexInput').value = initialColor;
            
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
            const hexInput = document.getElementById('hexInput');
            hexInput.addEventListener('input', (e) => {
                let value = e.target.value.trim();
                if (!value.startsWith('#')) value = '#' + value;
                if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
                    onBaseColorChange(value);
                }
            });
            
            // Enter „Ç≠„Éº„Åß„ÇÇÊõ¥Êñ∞
            hexInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    let value = e.target.value.trim();
                    if (!value.startsWith('#')) value = '#' + value;
                    if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
                        onBaseColorChange(value);
                    }
                }
            });
            
            const colorPreview = document.getElementById('colorPreview');
            colorPreview.addEventListener('click', () => {
                openColorPicker(state.baseColor, (newColor) => {
                    onBaseColorChange(newColor);
                });
            });
            
            document.getElementById('randomBtn').addEventListener('click', generateRandomColor);
            
            document.getElementById('copyBaseBtn').addEventListener('click', () => {
                copyToClipboard(state.baseColor).then(success => {
                    if (success) {
                        showToast(`${state.baseColor} „Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü`);
                    }
                });
            });
            
            // „Éë„Çø„Éº„É≥„Éà„Ç∞„É´ - ÂàùÊúüÁä∂ÊÖã„ÇÇË®≠ÂÆö
            document.querySelectorAll('.pattern-toggle input').forEach(input => {
                // ÂàùÊúü„ÉÅ„Çß„ÉÉ„ÇØÁä∂ÊÖã„ÇíË®≠ÂÆö
                input.checked = state.patternsEnabled[input.id] || false;
                
                input.addEventListener('change', (e) => {
                    togglePattern(e.target.id);
                });
            });
            
            // Êìç‰Ωú„Éú„Çø„É≥
            document.getElementById('refreshBtn').addEventListener('click', () => {
                rebuildCards();
                playFlip();
                showToast('„Éë„É¨„ÉÉ„Éà„ÇíÂÜçË®àÁÆó„Åó„Åæ„Åó„Åü');
            });
            
            document.getElementById('saveBtn').addEventListener('click', saveToHistory);
            document.getElementById('exportBtn').addEventListener('click', exportToPng);
            
            // „Ç´„É©„Éº„Éî„ÉÉ„Ç´„Éº„Ç§„Éô„É≥„Éà
            document.getElementById('pickerClose').addEventListener('click', closeColorPicker);
            document.getElementById('pickerCancel').addEventListener('click', closeColorPicker);
            document.getElementById('pickerOk').addEventListener('click', () => {
                if (colorPicker.callback) {
                    colorPicker.callback(colorPicker.currentColor);
                }
                closeColorPicker();
            });
            
            // „Éî„ÉÉ„Ç´„Éº„Çø„ÉñÂàáÊõø
            document.querySelectorAll('.picker-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const view = e.target.dataset.view;
                    colorPicker.currentView = view;
                    
                    // „Çø„Éñ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖãÊõ¥Êñ∞
                    document.querySelectorAll('.picker-tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    // „Éì„É•„ÉºÂàáÊõø
                    document.querySelectorAll('.picker-view').forEach(v => v.classList.remove('active'));
                    document.getElementById(view + 'View').classList.add('active');
                });
            });
            
            // „Çπ„Éö„ÇØ„Éà„É©„É†„Éî„ÉÉ„Ç´„Éº„Ç§„Éô„É≥„Éà
            const setupSpectrumPicker = () => {
                const spectrumPicker = document.getElementById('spectrumPicker');
                
                const updateSpectrum = (e) => {
                    const rect = spectrumPicker.getBoundingClientRect();
                    const x = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
                    const y = Math.max(0, Math.min(1, (e.clientY - rect.top) / rect.height));
                    
                    colorPicker.hsl.s = x;
                    colorPicker.hsl.l = Math.max(0, Math.min(1, 1 - y));
                    
                    const rgb = hslToRgb(colorPicker.hsl.h, colorPicker.hsl.s, colorPicker.hsl.l);
                    colorPicker.rgb = rgb;
                    updatePickerUI();
                };
                
                spectrumPicker.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    updateSpectrum(e);
                    
                    const handleMouseMove = (e) => {
                        e.preventDefault();
                        updateSpectrum(e);
                    };
                    
                    const handleMouseUp = () => {
                        document.removeEventListener('mousemove', handleMouseMove);
                        document.removeEventListener('mouseup', handleMouseUp);
                    };
                    
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                });
                
                // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„ÉàÂØæÂøú
                spectrumPicker.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    updateSpectrum(touch);
                    
                    const handleTouchMove = (e) => {
                        e.preventDefault();
                        const touch = e.touches[0];
                        updateSpectrum(touch);
                    };
                    
                    const handleTouchEnd = () => {
                        document.removeEventListener('touchmove', handleTouchMove);
                        document.removeEventListener('touchend', handleTouchEnd);
                    };
                    
                    document.addEventListener('touchmove', handleTouchMove, { passive: false });
                    document.addEventListener('touchend', handleTouchEnd);
                });
            };
            
            // Ëâ≤Áõ∏„Çπ„É©„Ç§„ÉÄ„Éº„Ç§„Éô„É≥„Éà
            const setupHueSlider = () => {
                const hueSlider = document.getElementById('hueSlider');
                
                const updateHue = (e) => {
                    const rect = hueSlider.getBoundingClientRect();
                    const x = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
                    colorPicker.hsl.h = x * 360;
                    
                    const rgb = hslToRgb(colorPicker.hsl.h, colorPicker.hsl.s, colorPicker.hsl.l);
                    colorPicker.rgb = rgb;
                    updatePickerUI();
                };
                
                hueSlider.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    updateHue(e);
                    
                    const handleMouseMove = (e) => {
                        e.preventDefault();
                        updateHue(e);
                    };
                    
                    const handleMouseUp = () => {
                        document.removeEventListener('mousemove', handleMouseMove);
                        document.removeEventListener('mouseup', handleMouseUp);
                    };
                    
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                });
                
                hueSlider.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    updateHue(touch);
                    
                    const handleTouchMove = (e) => {
                        e.preventDefault();
                        const touch = e.touches[0];
                        updateHue(touch);
                    };
                    
                    const handleTouchEnd = () => {
                        document.removeEventListener('touchmove', handleTouchMove);
                        document.removeEventListener('touchend', handleTouchEnd);
                    };
                    
                    document.addEventListener('touchmove', handleTouchMove, { passive: false });
                    document.addEventListener('touchend', handleTouchEnd);
                });
            };
            
            // RGB„Çπ„É©„Ç§„ÉÄ„Éº„Ç§„Éô„É≥„Éà
            const setupRGBSliders = () => {
                ['red', 'green', 'blue'].forEach((channel, index) => {
                    const slider = document.getElementById(channel + 'Slider');
                    const channelNames = ['r', 'g', 'b'];
                    
                    const updateChannel = (e) => {
                        const rect = slider.getBoundingClientRect();
                        const x = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
                        colorPicker.rgb[channelNames[index]] = x * 255;
                        
                        const hsl = rgbToHsl(colorPicker.rgb.r, colorPicker.rgb.g, colorPicker.rgb.b);
                        colorPicker.hsl = hsl;
                        updatePickerUI();
                    };
                    
                    slider.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        updateChannel(e);
                        
                        const handleMouseMove = (e) => {
                            e.preventDefault();
                            updateChannel(e);
                        };
                        
                        const handleMouseUp = () => {
                            document.removeEventListener('mousemove', handleMouseMove);
                            document.removeEventListener('mouseup', handleMouseUp);
                        };
                        
                        document.addEventListener('mousemove', handleMouseMove);
                        document.addEventListener('mouseup', handleMouseUp);
                    });
                    
                    slider.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        const touch = e.touches[0];
                        updateChannel(touch);
                        
                        const handleTouchMove = (e) => {
                            e.preventDefault();
                            const touch = e.touches[0];
                            updateChannel(touch);
                        };
                        
                        const handleTouchEnd = () => {
                            document.removeEventListener('touchmove', handleTouchMove);
                            document.removeEventListener('touchend', handleTouchEnd);
                        };
                        
                        document.addEventListener('touchmove', handleTouchMove, { passive: false });
                        document.addEventListener('touchend', handleTouchEnd);
                    });
                });
            };
            
            setupSpectrumPicker();
            setupHueSlider();
            setupRGBSliders();
            
            // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
            document.getElementById('colorPickerModal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    closeColorPicker();
                }
            });
            
            // „Ç´„Éº„Éâ„Ç§„Éô„É≥„ÉàÔºàÂãïÁöÑÔºâ
            document.addEventListener('click', (e) => {
                // Ëâ≤„Çπ„Ç¶„Ç©„ÉÉ„ÉÅ„ÅÆ„ÇØ„É™„ÉÉ„ÇØ - „Ç≥„Éî„Éº + „ÅäÊ∞ó„Å´ÂÖ•„ÇäËøΩÂä†
                if (e.target.classList.contains('color-swatch')) {
                    const color = e.target.dataset.color;
                    if (color) {
                        handleColorClick(color);
                    }
                    return;
                }
                
                // HEXÂÄ§„ÅÆ„ÇØ„É™„ÉÉ„ÇØ - „Ç≥„Éî„Éº„ÅÆ„Åø
                if (e.target.classList.contains('hex-item')) {
                    const color = e.target.dataset.color;
                    if (color) {
                        copyToClipboard(color).then(success => {
                            if (success) {
                                showToast(`${color} „Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü`);
                            }
                        });
                    }
                    return;
                }
                
                // „ÅäÊ∞ó„Å´ÂÖ•„ÇäÂâäÈô§„Éú„Çø„É≥
                if (e.target.classList.contains('favorite-remove')) {
                    e.stopPropagation();
                    const color = e.target.dataset.color;
                    if (color) {
                        removeFromFavorites(color);
                    }
                    return;
                }
                
                // „Ç´„Éº„ÉâÈñâ„Åò„Çã„Éú„Çø„É≥
                if (e.target.classList.contains('card-close')) {
                    const pattern = e.target.dataset.pattern;
                    if (pattern) {
                        togglePattern(pattern);
                    }
                    return;
                }
            });
            
            // „ÅäÊ∞ó„Å´ÂÖ•„ÇäÈñ¢ÈÄ£„ÅÆ„Ç§„Éô„É≥„Éà
            const clearFavoritesBtn = document.getElementById('clearFavoritesBtn');
            const exportFavoritesBtn = document.getElementById('exportFavoritesBtn');
            
            if (clearFavoritesBtn) {
                clearFavoritesBtn.addEventListener('click', clearFavorites);
            }
            if (exportFavoritesBtn) {
                exportFavoritesBtn.addEventListener('click', exportFavoritesPng);
            }
            
            // „Ç≠„Éº„Éú„Éº„Éâ„Çµ„Éù„Éº„Éà
            document.addEventListener('keydown', (e) => {
                if (e.target.classList.contains('color-swatch') && e.key === 'Enter') {
                    const color = e.target.dataset.color;
                    if (color) {
                        copyToClipboard(color);
                    }
                }
            });
            
            // ÂàùÊúü„É¨„É≥„ÉÄ„É™„É≥„Ç∞
            loadHistory();
            loadFavorites();
            generateColorGrid();
            rebuildCards();
            renderCards();
        }

        // DOMË™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„Å´ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

